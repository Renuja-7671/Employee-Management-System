generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model Attendance {
  id         String           @id @default(uuid())
  employeeId String
  date       DateTime
  checkIn    DateTime?
  checkOut   DateTime?
  status     AttendanceStatus
  workHours  Float?
  isWeekend  Boolean          @default(false)
  notes      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @default(now()) @updatedAt
  deviceId   String?
  source     AttendanceSource @default(MANUAL)
  verifyMode Int?
  User       User             @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([date])
  @@index([deviceId])
  @@index([employeeId])
}

model AttendanceLog {
  id               String    @id @default(uuid())
  deviceEmployeeNo String
  employeeId       String?
  timestamp        DateTime
  verifyMode       Int
  inOutType        Int
  deviceId         String?
  deviceName       String?
  processed        Boolean   @default(false)
  processedAt      DateTime?
  errorMessage     String?
  createdAt        DateTime  @default(now())

  @@index([deviceEmployeeNo])
  @@index([employeeId])
  @@index([processed])
  @@index([timestamp])
}

model BiometricDevice {
  id              String     @id @default(uuid())
  name            String
  deviceType      DeviceType
  ipAddress       String
  port            Int        @default(80)
  username        String
  password        String
  serialNumber    String?    @unique
  model           String?
  firmwareVersion String?
  macAddress      String?
  isActive        Boolean    @default(true)
  lastSyncAt      DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @default(now()) @updatedAt

  @@index([isActive])
  @@index([serialNumber])
}

model BiometricMapping {
  id                  String    @id @default(uuid())
  employeeId          String    @unique
  deviceEmployeeNo    String    @unique
  cardNo              String?
  fingerprintEnrolled Boolean   @default(false)
  faceEnrolled        Boolean   @default(false)
  syncedAt            DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @default(now()) @updatedAt
  employee            User      @relation("BiometricMappingEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
}

model CoverDutyReassignment {
  id                      String   @id @default(uuid())
  originalLeaveId         String
  coverEmployeeLeaveId    String
  originalCoverEmployeeId String
  newCoverEmployeeId      String?
  reassignedBy            String?
  status                  String   @default("PENDING")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @default(now()) @updatedAt

  @@index([coverEmployeeLeaveId])
  @@index([originalLeaveId])
  @@index([status])
}

model CoverRequest {
  id              String      @id @default(uuid())
  leaveId         String      @unique
  coverEmployeeId String
  status          CoverStatus @default(PENDING)
  responseMessage String?
  requestedAt     DateTime    @default(now())
  respondedAt     DateTime?
  expiresAt       DateTime
  User            User        @relation(fields: [coverEmployeeId], references: [id])
  Leave           Leave       @relation(fields: [leaveId], references: [id], onDelete: Cascade)

  @@index([coverEmployeeId])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Leave {
  id                  String        @id @default(uuid())
  employeeId          String
  leaveType           LeaveType
  startDate           DateTime
  endDate             DateTime
  totalDays           Float
  reason              String
  status              LeaveStatus   @default(PENDING_COVER)
  adminResponse       String?
  coverEmployeeId     String?
  medicalCertPath     String?
  isCancelled         Boolean       @default(false)
  cancellationReason  String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @default(now()) @updatedAt
  isNoPay             Boolean       @default(false)
  halfDayType         String?       // For official leave half days: 'FIRST_HALF' or 'SECOND_HALF'
  CoverRequest        CoverRequest?
  coverEmployee       User?         @relation("Leave_coverEmployeeIdToUser", fields: [coverEmployeeId], references: [id])
  employee            User          @relation("Leave_employeeIdToUser", fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([startDate])
  @@index([status])
}

model LeaveBalance {
  id         String   @id @default(uuid())
  employeeId String   @unique
  year       Int
  annual     Float    @default(14)
  casual     Float    @default(7)
  medical    Float    @default(7)
  updatedAt  DateTime @default(now()) @updatedAt
  official   Float    @default(0)
  User       User     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([year])
}

model Notification {
  id                               String           @id @default(uuid())
  userId                           String
  type                             NotificationType
  title                            String
  message                          String
  isRead                           Boolean          @default(false)
  senderId                         String?
  relatedId                        String?
  createdAt                        DateTime         @default(now())
  isPinned                         Boolean          @default(false)
  User_Notification_senderIdToUser User?            @relation("Notification_senderIdToUser", fields: [senderId], references: [id])
  User_Notification_userIdToUser   User             @relation("Notification_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isPinned])
  @@index([isRead])
  @@index([userId])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model PublicHoliday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime
  description String?
  createdAt   DateTime @default(now())

  @@index([date])
}

model User {
  id                                       String               @id @default(uuid())
  email                                    String               @unique
  password                                 String
  role                                     Role                 @default(EMPLOYEE)
  employeeId                               String               @unique
  firstName                                String?
  lastName                                 String?
  nameWithInitials                         String?
  department                               Department
  position                                 String
  phoneNumber                              String?
  birthday                                 DateTime?
  address                                  String?
  emergencyContact                         String?
  profilePicture                           String?
  dateOfJoining                            DateTime             @default(now())
  isActive                                 Boolean              @default(true)
  createdAt                                DateTime             @default(now())
  updatedAt                                DateTime             @default(now()) @updatedAt
  adminType                                AdminType?
  nic                                      String?              @unique
  callingName                              String?
  fullName                                 String?
  isProbation                              Boolean              @default(true)
  confirmedAt                              DateTime?
  Attendance                               Attendance[]
  BiometricMapping                         BiometricMapping?                @relation("BiometricMappingEmployee")
  CoverRequest                             CoverRequest[]
  leavesCovered                            Leave[]              @relation("Leave_coverEmployeeIdToUser")
  leaves                                   Leave[]              @relation("Leave_employeeIdToUser")
  LeaveBalance                             LeaveBalance?
  Notification_Notification_senderIdToUser Notification[]       @relation("Notification_senderIdToUser")
  Notification_Notification_userIdToUser   Notification[]       @relation("Notification_userIdToUser")
  PasswordResetToken                       PasswordResetToken[]

  @@index([birthday])
  @@index([department])
  @@index([email])
  @@index([employeeId])
  @@index([nic])
}

enum AdminType {
  MANAGING_DIRECTOR
  HR_HEAD
  RESERVED
}

enum AttendanceSource {
  MANUAL
  BIOMETRIC
  MOBILE
  WEB
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  LEAVE
  HOLIDAY
}

enum CoverStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum Department {
  MANAGEMENT
  SALES_AND_MARKETING
  FINANCE
  STORES
  PROCUREMENT
  HR
  IT
}

enum DeviceType {
  HIKVISION
  ZK_TECO
  OTHER
}

enum LeaveStatus {
  PENDING_COVER
  PENDING_ADMIN
  APPROVED
  DECLINED
  CANCELLED
}

enum LeaveType {
  ANNUAL
  CASUAL
  MEDICAL
  OFFICIAL
}

enum NotificationType {
  LEAVE_REQUEST
  LEAVE_APPROVED
  LEAVE_DECLINED
  LEAVE_CANCELLED
  COVER_REQUEST
  COVER_ACCEPTED
  COVER_DECLINED
  ATTENDANCE_ALERT
  LEAVE_BALANCE_LOW
  SYSTEM_ALERT
  COVERING_DUTY_CONFLICT
  DUTY_REASSIGNMENT_REQUIRED
}

enum Role {
  ADMIN
  EMPLOYEE
}
